; PlatformIO Project Configuration File
;
; USD - Ultimate Stepper Driver
; Copyright (c) 2025 Camilo Valencia. All rights reserved.
;
; Environments:
;   esp32s3     - Primary development target (ESP32-S3 DevKit)
;   native      - Host-based unit testing

[platformio]
default_envs = esp32s3
src_dir = src
include_dir = include
lib_dir = lib
test_dir = test

; =============================================================================
; Common Settings
; =============================================================================

[env]
monitor_speed = 115200
build_flags = 
    -D USD_VERSION=\"0.1.0\"
    -D USD_DEBUG=1
    -Wall
    -Wextra
lib_deps =
    ; Dependencies added as needed

; =============================================================================
; ESP32-S3 DevKit Environment (Primary Target)
; =============================================================================

[env:esp32s3]
platform = espressif32
framework = arduino
; ESP32-S3-DevKitC-1 with N16R8 module (16MB Flash, 8MB PSRAM)
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L

; N16R8 memory configuration
board_build.flash_size = 16MB
board_build.psram = enabled
board_upload.flash_size = 16MB

; USB-CDC for programming and serial monitor
upload_protocol = esptool
monitor_port = auto

; Partition table for 16MB flash (more OTA/app space)
board_build.partitions = default_16MB.csv

build_flags = 
    ${env.build_flags}
    ; USB-CDC on boot (no external UART needed)
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    ; FreeRTOS settings
    -D CONFIG_FREERTOS_HZ=1000
    ; PSRAM configuration
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -D CONFIG_FREERTOS_UNICORE=0
    ; Hardware timer for stepping
    -D USD_USE_MCPWM=1

; Library dependencies for ESP32
lib_deps = 
    ${env.lib_deps}

; =============================================================================
; Native Environment (Host Unit Tests)
; =============================================================================

[env:native]
platform = native
build_flags = 
    ${env.build_flags}
    -D USD_NATIVE_TEST=1
    -D USD_MOCK_HARDWARE=1
    -std=c++17
test_framework = unity
lib_deps =
    ${env.lib_deps}

; Ignore hardware-specific files in native tests
lib_ignore = 
    usd_drivers
    usd_sensors

; =============================================================================
; Future: STM32 Environment (post-v1.0)
; =============================================================================

; [env:stm32f4]
; platform = ststm32
; board = nucleo_f446re
; framework = arduino
